-- HRMS Deduction Templates Database Schema
-- Migration file for creating all deduction template tables in branch schema
-- ===============================================================================

-- Enable UUID extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- 1. DEDUCTION TYPES TABLE
-- Master table for all types of deductions (PF, ESI, Tax, etc.)
CREATE TABLE IF NOT EXISTS branch.deduction_types (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name varchar(100) NOT NULL,
  code varchar(20) NOT NULL,
  description text NULL,
  calculation_method varchar(20) NULL DEFAULT 'fixed',
  default_amount numeric(10, 2) NULL DEFAULT 0,
  is_tax_deductible boolean NULL DEFAULT false,
  is_mandatory boolean NULL DEFAULT false,
  is_active boolean NULL DEFAULT true,
  created_at timestamp with time zone NULL DEFAULT now(),
  updated_at timestamp with time zone NULL DEFAULT now(),
  CONSTRAINT deduction_types_pkey PRIMARY KEY (id),
  CONSTRAINT deduction_types_code_key UNIQUE (code)
);

-- 2. DEDUCTION TEMPLATES TABLE
-- Main templates grouped by employee type (teacher, staff, driver)
CREATE TABLE IF NOT EXISTS branch.deduction_templates (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  template_name varchar(100) NOT NULL,
  employee_type varchar(20) NOT NULL,
  description text NULL,
  is_active boolean NULL DEFAULT true,
  created_by uuid NULL,
  created_at timestamp with time zone NULL DEFAULT now(),
  updated_at timestamp with time zone NULL DEFAULT now(),
  CONSTRAINT deduction_templates_pkey PRIMARY KEY (id),
  CONSTRAINT deduction_templates_created_by_fkey FOREIGN KEY (created_by) REFERENCES users (id),
  CONSTRAINT deduction_templates_employee_type_check CHECK (
    employee_type::text = ANY (
      ARRAY['teacher', 'staff', 'driver']::text[]
    )
  )
);

-- 3. DEDUCTION TEMPLATE ITEMS TABLE
-- Individual deductions within each template
CREATE TABLE IF NOT EXISTS branch.deduction_template_items (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  template_id uuid NULL,
  deduction_type_id uuid NULL,
  calculation_type varchar(20) NOT NULL,
  calculation_value numeric(10, 2) NOT NULL,
  is_mandatory boolean NULL DEFAULT true,
  created_at timestamp with time zone NULL DEFAULT now(),
  CONSTRAINT deduction_template_items_pkey PRIMARY KEY (id),
  CONSTRAINT deduction_template_items_template_id_deduction_type_id_key UNIQUE (template_id, deduction_type_id),
  CONSTRAINT deduction_template_items_deduction_type_id_fkey FOREIGN KEY (deduction_type_id) REFERENCES branch.deduction_types (id) ON DELETE CASCADE,
  CONSTRAINT deduction_template_items_template_id_fkey FOREIGN KEY (template_id) REFERENCES branch.deduction_templates (id) ON DELETE CASCADE,
  CONSTRAINT deduction_template_items_calculation_type_check CHECK (
    calculation_type::text = ANY (
      ARRAY['percentage', 'fixed_amount']::text[]
    )
  )
);

-- 4. EMPLOYEE DEDUCTION TEMPLATES TABLE
-- Assignment of templates to employees
CREATE TABLE IF NOT EXISTS branch.employee_deduction_templates (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  employee_id uuid NULL,
  template_id uuid NULL,
  assigned_date date NULL DEFAULT CURRENT_DATE,
  is_active boolean NULL DEFAULT true,
  assigned_by uuid NULL,
  created_at timestamp with time zone NULL DEFAULT now(),
  CONSTRAINT employee_deduction_templates_pkey PRIMARY KEY (id),
  CONSTRAINT employee_deduction_templates_employee_id_key UNIQUE (employee_id),
  CONSTRAINT employee_deduction_templates_assigned_by_fkey FOREIGN KEY (assigned_by) REFERENCES users (id),
  CONSTRAINT employee_deduction_templates_employee_id_fkey FOREIGN KEY (employee_id) REFERENCES users (id) ON DELETE CASCADE,
  CONSTRAINT employee_deduction_templates_template_id_fkey FOREIGN KEY (template_id) REFERENCES branch.deduction_templates (id) ON DELETE CASCADE
);

-- 5. EMPLOYEE DEDUCTION OVERRIDES TABLE
-- Individual employee customizations for specific deductions
CREATE TABLE IF NOT EXISTS branch.employee_deduction_overrides (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  employee_id uuid NULL,
  deduction_type_id uuid NULL,
  override_type varchar(20) NULL,
  override_value numeric(10, 2) NOT NULL,
  effective_from date NULL DEFAULT CURRENT_DATE,
  effective_to date NULL,
  reason text NULL,
  created_by uuid NULL,
  created_at timestamp with time zone NULL DEFAULT now(),
  CONSTRAINT employee_deduction_overrides_pkey PRIMARY KEY (id),
  CONSTRAINT employee_deduction_overrides_created_by_fkey FOREIGN KEY (created_by) REFERENCES users (id),
  CONSTRAINT employee_deduction_overrides_deduction_type_id_fkey FOREIGN KEY (deduction_type_id) REFERENCES branch.deduction_types (id) ON DELETE CASCADE,
  CONSTRAINT employee_deduction_overrides_employee_id_fkey FOREIGN KEY (employee_id) REFERENCES users (id) ON DELETE CASCADE,
  CONSTRAINT employee_deduction_overrides_override_type_check CHECK (
    override_type::text = ANY (
      ARRAY['percentage', 'fixed_amount']::text[]
    )
  )
);

-- PERFORMANCE INDEXES
-- ===============================================================================

-- Deduction Types Indexes
CREATE INDEX IF NOT EXISTS idx_deduction_types_active ON branch.deduction_types (is_active);
CREATE INDEX IF NOT EXISTS idx_deduction_types_code ON branch.deduction_types (code);

-- Deduction Templates Indexes
CREATE INDEX IF NOT EXISTS idx_deduction_templates_employee_type ON branch.deduction_templates (employee_type);
CREATE INDEX IF NOT EXISTS idx_deduction_templates_active ON branch.deduction_templates (is_active);
CREATE INDEX IF NOT EXISTS idx_deduction_templates_created_by ON branch.deduction_templates (created_by);

-- Deduction Template Items Indexes
CREATE INDEX IF NOT EXISTS idx_deduction_template_items_template ON branch.deduction_template_items (template_id);
CREATE INDEX IF NOT EXISTS idx_deduction_template_items_type ON branch.deduction_template_items (deduction_type_id);

-- Employee Deduction Templates Indexes
CREATE INDEX IF NOT EXISTS idx_employee_deduction_templates_employee ON branch.employee_deduction_templates (employee_id);
CREATE INDEX IF NOT EXISTS idx_employee_deduction_templates_template ON branch.employee_deduction_templates (template_id);
CREATE INDEX IF NOT EXISTS idx_employee_deduction_templates_active ON branch.employee_deduction_templates (is_active);

-- Employee Deduction Overrides Indexes
CREATE INDEX IF NOT EXISTS idx_deduction_overrides_employee ON branch.employee_deduction_overrides (employee_id);
CREATE INDEX IF NOT EXISTS idx_deduction_overrides_type ON branch.employee_deduction_overrides (deduction_type_id);
CREATE INDEX IF NOT EXISTS idx_deduction_overrides_effective_from ON branch.employee_deduction_overrides (effective_from);

-- DATA TRIGGERS
-- ===============================================================================

-- Function to update updated_at column
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

-- Apply triggers to relevant tables
DROP TRIGGER IF EXISTS update_deduction_types_updated_at ON branch.deduction_types;
CREATE TRIGGER update_deduction_types_updated_at
    BEFORE UPDATE ON branch.deduction_types
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

DROP TRIGGER IF EXISTS update_deduction_templates_updated_at ON branch.deduction_templates;
CREATE TRIGGER update_deduction_templates_updated_at
    BEFORE UPDATE ON branch.deduction_templates
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- ROW LEVEL SECURITY (RLS)
-- ===============================================================================

-- Enable RLS on all tables
ALTER TABLE branch.deduction_types ENABLE ROW LEVEL SECURITY;
ALTER TABLE branch.deduction_templates ENABLE ROW LEVEL SECURITY;
ALTER TABLE branch.deduction_template_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE branch.employee_deduction_templates ENABLE ROW LEVEL SECURITY;
ALTER TABLE branch.employee_deduction_overrides ENABLE ROW LEVEL SECURITY;

-- RLS Policies for Deduction Types
CREATE POLICY "Allow authenticated users to view deduction types" ON branch.deduction_types 
    FOR SELECT USING (auth.role() = 'authenticated');

CREATE POLICY "Allow HR to manage deduction types" ON branch.deduction_types 
    FOR ALL USING (auth.jwt() ->> 'role' IN ('admin', 'hr'));

-- RLS Policies for Deduction Templates
CREATE POLICY "Allow authenticated users to view deduction templates" ON branch.deduction_templates 
    FOR SELECT USING (auth.role() = 'authenticated');

CREATE POLICY "Allow HR to manage deduction templates" ON branch.deduction_templates 
    FOR ALL USING (auth.jwt() ->> 'role' IN ('admin', 'hr'));

-- RLS Policies for Deduction Template Items
CREATE POLICY "Allow authenticated users to view template items" ON branch.deduction_template_items 
    FOR SELECT USING (auth.role() = 'authenticated');

CREATE POLICY "Allow HR to manage template items" ON branch.deduction_template_items 
    FOR ALL USING (auth.jwt() ->> 'role' IN ('admin', 'hr'));

-- RLS Policies for Employee Template Assignments
CREATE POLICY "Allow authenticated users to view employee templates" ON branch.employee_deduction_templates 
    FOR SELECT USING (auth.role() = 'authenticated');

CREATE POLICY "Allow HR to manage employee templates" ON branch.employee_deduction_templates 
    FOR ALL USING (auth.jwt() ->> 'role' IN ('admin', 'hr'));

-- RLS Policies for Employee Deduction Overrides
CREATE POLICY "Allow authenticated users to view deduction overrides" ON branch.employee_deduction_overrides 
    FOR SELECT USING (auth.role() = 'authenticated');

CREATE POLICY "Allow HR to manage deduction overrides" ON branch.employee_deduction_overrides 
    FOR ALL USING (auth.jwt() ->> 'role' IN ('admin', 'hr'));

-- SAMPLE DATA INSERTION
-- ===============================================================================

-- Insert sample deduction types
INSERT INTO branch.deduction_types (name, code, description, calculation_method, default_amount, is_tax_deductible, is_mandatory) VALUES
('Provident Fund', 'PF', 'Employee Provident Fund contribution', 'percentage', 12.00, true, true),
('Employee State Insurance', 'ESI', 'ESI contribution for employee', 'percentage', 0.75, true, true),
('Professional Tax', 'PT', 'Professional Tax deduction', 'fixed', 200.00, true, true),
('Income Tax', 'TDS', 'Tax Deducted at Source', 'percentage', 0.00, true, false),
('Loan Repayment', 'LOAN', 'Employee loan repayment deduction', 'fixed', 0.00, false, false),
('Advance Salary', 'ADV', 'Salary advance recovery', 'fixed', 0.00, false, false),
('Insurance Premium', 'INS', 'Group insurance premium deduction', 'fixed', 0.00, false, false)
ON CONFLICT (code) DO NOTHING;

-- Insert sample deduction templates
DO $$
DECLARE
    pf_type_id uuid;
    esi_type_id uuid;
    pt_type_id uuid;
    tds_type_id uuid;
BEGIN
    -- Get deduction type IDs
    SELECT id INTO pf_type_id FROM branch.deduction_types WHERE code = 'PF';
    SELECT id INTO esi_type_id FROM branch.deduction_types WHERE code = 'ESI';
    SELECT id INTO pt_type_id FROM branch.deduction_types WHERE code = 'PT';
    SELECT id INTO tds_type_id FROM branch.deduction_types WHERE code = 'TDS';

    -- Teacher Template
    IF NOT EXISTS (SELECT 1 FROM branch.deduction_templates WHERE template_name = 'Teacher Standard Deductions' AND employee_type = 'teacher') THEN
        INSERT INTO branch.deduction_templates (template_name, employee_type, description) VALUES
        ('Teacher Standard Deductions', 'teacher', 'Standard statutory deductions for teaching staff');
        
        INSERT INTO branch.deduction_template_items (template_id, deduction_type_id, calculation_type, calculation_value, is_mandatory)
        SELECT dt.id, pf_type_id, 'percentage', 12.00, true FROM branch.deduction_templates dt WHERE dt.template_name = 'Teacher Standard Deductions';
        
        INSERT INTO branch.deduction_template_items (template_id, deduction_type_id, calculation_type, calculation_value, is_mandatory)
        SELECT dt.id, esi_type_id, 'percentage', 0.75, true FROM branch.deduction_templates dt WHERE dt.template_name = 'Teacher Standard Deductions';
        
        INSERT INTO branch.deduction_template_items (template_id, deduction_type_id, calculation_type, calculation_value, is_mandatory)
        SELECT dt.id, pt_type_id, 'fixed_amount', 200.00, true FROM branch.deduction_templates dt WHERE dt.template_name = 'Teacher Standard Deductions';
    END IF;

    -- Staff Template
    IF NOT EXISTS (SELECT 1 FROM branch.deduction_templates WHERE template_name = 'Staff Standard Deductions' AND employee_type = 'staff') THEN
        INSERT INTO branch.deduction_templates (template_name, employee_type, description) VALUES
        ('Staff Standard Deductions', 'staff', 'Standard statutory deductions for non-teaching staff');
        
        INSERT INTO branch.deduction_template_items (template_id, deduction_type_id, calculation_type, calculation_value, is_mandatory)
        SELECT dt.id, pf_type_id, 'percentage', 12.00, true FROM branch.deduction_templates dt WHERE dt.template_name = 'Staff Standard Deductions';
        
        INSERT INTO branch.deduction_template_items (template_id, deduction_type_id, calculation_type, calculation_value, is_mandatory)
        SELECT dt.id, esi_type_id, 'percentage', 0.75, true FROM branch.deduction_templates dt WHERE dt.template_name = 'Staff Standard Deductions';
        
        INSERT INTO branch.deduction_template_items (template_id, deduction_type_id, calculation_type, calculation_value, is_mandatory)
        SELECT dt.id, pt_type_id, 'fixed_amount', 150.00, true FROM branch.deduction_templates dt WHERE dt.template_name = 'Staff Standard Deductions';
    END IF;

    -- Driver Template
    IF NOT EXISTS (SELECT 1 FROM branch.deduction_templates WHERE template_name = 'Driver Standard Deductions' AND employee_type = 'driver') THEN
        INSERT INTO branch.deduction_templates (template_name, employee_type, description) VALUES
        ('Driver Standard Deductions', 'driver', 'Standard deductions for drivers');
        
        INSERT INTO branch.deduction_template_items (template_id, deduction_type_id, calculation_type, calculation_value, is_mandatory)
        SELECT dt.id, pf_type_id, 'percentage', 12.00, true FROM branch.deduction_templates dt WHERE dt.template_name = 'Driver Standard Deductions';
        
        INSERT INTO branch.deduction_template_items (template_id, deduction_type_id, calculation_type, calculation_value, is_mandatory)
        SELECT dt.id, pt_type_id, 'fixed_amount', 100.00, true FROM branch.deduction_templates dt WHERE dt.template_name = 'Driver Standard Deductions';
    END IF;
END $$;

-- GRANT PERMISSIONS
-- ===============================================================================

-- Grant necessary permissions (adjust as per your security requirements)
GRANT USAGE ON SCHEMA branch TO authenticated;
GRANT ALL ON ALL TABLES IN SCHEMA branch TO authenticated;
GRANT ALL ON ALL SEQUENCES IN SCHEMA branch TO authenticated;

-- Final confirmation message
DO $$
BEGIN
    RAISE NOTICE 'HRMS Deduction Templates tables created successfully in branch schema!';
    RAISE NOTICE 'Tables created:';
    RAISE NOTICE '- branch.deduction_types';
    RAISE NOTICE '- branch.deduction_templates';
    RAISE NOTICE '- branch.deduction_template_items';
    RAISE NOTICE '- branch.employee_deduction_templates';
    RAISE NOTICE '- branch.employee_deduction_overrides';
    RAISE NOTICE 'Sample data inserted with default deduction types and templates.';
END $$;